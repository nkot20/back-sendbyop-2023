CAHIER DES CHARGES FONCTIONNEL DÉTAILLÉ - APPLICATION SENDBYOP

1. PRÉSENTATION GÉNÉRALE DU PROJET
   1.1. Objectif
        SendByOp est une plateforme collaborative de type "Crowd-shipping" permettant de mettre en relation :
        - Des voyageurs (Travelers) qui effectuent des trajets aériens et disposent de kilos inutilisés dans leurs bagages.
        - Des expéditeurs (Customers) qui souhaitent envoyer des colis rapidement et à moindre coût vers ces destinations.
   
   1.2. Architecture Fonctionnelle
        L'application est construite autour d'une architecture modulaire gérant l'ensemble du cycle de vie d'un transport de colis, de la publication du vol jusqu'à la confirmation de réception par le destinataire, en passant par la sécurisation des paiements et la vérification des identités.

2. ACTEURS ET RÔLES
   2.1. Visiteur (Guest)
        - Utilisateur non connecté.
        - Peut consulter les vols disponibles (API publique).
        - Peut s'inscrire à la newsletter.
        - Peut initier une inscription ou une connexion.

   2.2. Client / Expéditeur (Customer)
        - Utilisateur authentifié avec le rôle "CUSTOMER".
        - Recherche des vols.
        - Crée des réservations pour expédier des colis.
        - Gère ses destinataires.
        - Effectue les paiements.
        - Suit l'état de ses expéditions.
        - Note les voyageurs.

   2.3. Voyageur (User/Traveler)
        - Utilisateur authentifié avec le rôle "USER".
        - Publie ses vols et ses capacités de transport (kilos disponibles).
        - Accepte ou refuse les demandes de réservation.
        - Confirme la prise en charge et la livraison des colis.
        - Gère ses informations de virement (Payouts) pour récupérer ses gains.

   2.4. Administrateur (Admin)
        - Utilisateur authentifié avec le rôle "ADMIN".
        - Valide ou rejette les vols publiés par les voyageurs.
        - Accède aux statistiques globales (financières, utilisateurs, opérations).
        - Gère les utilisateurs (blocage, suppression).
        - Supervise les opérations de remboursement et de litige.

3. MODULES FONCTIONNELS DÉTAILLÉS

   3.1. MODULE AUTHENTIFICATION ET SÉCURITÉ (Auth & Registration)
        Ce module assure la gestion sécurisée des accès et des identités.

        3.1.1. Inscription (Sign Up)
             - Inscription Client : Saisie email, mot de passe, prénom, nom, téléphone. Envoi automatique d'un email de vérification.
             - Inscription Admin : Processus spécifique sécurisé (réservé profil 'dev' ou interne).
             - Vérification Email : Système de token unique envoyé par email pour activer le compte.
             - Vérification Téléphone : Intégration (Twilio) pour validation par code SMS (OTP).

        3.1.2. Connexion (Login)
             - Authentification par Email/Mot de passe.
             - Génération d'un Token JWT (JSON Web Token) sécurisé pour les sessions.
             - Gestion des rôles et permissions via le token.

        3.1.3. Gestion de Mot de Passe
             - "Mot de passe oublié" : Envoi d'un lien de réinitialisation par email.
             - Vérification du token de réinitialisation.
             - Définition du nouveau mot de passe.
             - Changement de mot de passe depuis l'espace connecté.

   3.2. MODULE GESTION DES UTILISATEURS (User Management)
        Gestion des profils et informations personnelles.

        3.2.1. Profil Utilisateur
             - Modification des informations personnelles (Nom, Prénom, Adresse).
             - Upload de photo de profil (Sécurisé, formats images acceptés, limite de taille).
             - Consultation du statut du compte.

        3.2.2. Informations Bancaires (Bank Accounts)
             - Enregistrement des coordonnées bancaires (IBAN, BIC, Titulaire) pour les voyageurs (pour recevoir les paiements).
             - Chiffrement des données sensibles en base de données.
             - Consultation et mise à jour des coordonnées.

        3.2.3. Conformité et Documents (KYC)
             - Upload de documents d'identité (CNI, Passeport) pour validation du profil voyageur.

   3.3. MODULE GESTION DES VOLS (Flight Management)
        Cœur de l'offre de transport.

        3.3.1. Publication d'un Vol (Voyageur)
             - Saisie des détails : Aéroport de départ, Aéroport d'arrivée, Date/Heure départ, Date/Heure arrivée.
             - Définition de la capacité : Nombre de Kilos disponibles à la vente.
             - Prix : Définition du prix par Kilo.
             - Escales : Possibilité d'ajouter des escales avec aéroports et horaires intermédiaires.
             - Compagnie aérienne et numéro de vol.

        3.3.2. Workflow de Validation (Admin)
             - Statut "En attente" (Pending) à la création.
             - Validation manuelle par un administrateur (Passage au statut "Validé").
             - Rejet avec motif possible (Passage au statut "Rejeté").
             - Seuls les vols validés sont visibles publiquement pour réservation.

        3.3.3. Recherche et Consultation (Public/Client)
             - Liste des vols actifs et validés.
             - Filtrage par date, départ, arrivée.
             - Pagination des résultats.
             - Vue détaillée d'un vol (capacité restante, prix, escales).

        3.3.4. Gestion des Vols (Voyageur)
             - Consultation de ses propres vols (actifs, passés, en attente).
             - Annulation d'un vol (avec gestion des impacts sur les réservations associées).
             - Mise à jour des informations (tant que non validé ou sans réservation).

   3.4. MODULE RÉSERVATIONS ET COLIS (Booking & Shipping)
        Processus de contractualisation du transport.

        3.4.1. Création de Réservation (Client)
             - Sélection d'un vol existant.
             - Définition du Colis :
               * Poids (kg).
               * Dimensions (L x l x h).
               * Description du contenu.
               * Catégorie d'objet.
               * Valeur estimée.
             - Photos du Colis : Upload obligatoire de 1 à 5 photos pour prouver l'état et le contenu (Preuve visuelle).
             - Destinataire (Receiver) :
               * Création d'un nouveau destinataire ou sélection d'un existant.
               * Nom, Prénom, Email, Téléphone, Adresse de livraison.
             - Proposition de prix (Optionnel) : Le système calcule un prix suggéré, mais le client peut proposer un montant.

        3.4.2. Cycle de Vie d'une Réservation (Workflow Statuts)
             1. PENDING_CONFIRMATION : Créée par le client, en attente d'action du voyageur.
             2. CONFIRMED_UNPAID : Acceptée par le voyageur, en attente de paiement du client.
             3. CANCELLED_BY_TRAVELER : Refusée par le voyageur (Motif requis).
             4. CANCELLED_BY_CLIENT : Annulée par le client avant paiement ou confirmation.
             5. CONFIRMED_PAID : Payée par le client. Prête pour l'expédition.
             6. DELIVERED : Le voyageur indique avoir livré le colis au destinataire.
             7. PICKED_UP : Le client/destinataire confirme avoir récupéré le colis (Fin du cycle nominal).
             8. CANCELLED_PAYMENT_TIMEOUT : Annulation automatique si paiement non reçu dans les délais.

        3.4.3. Gestion des Réservations (Voyageur)
             - Réception des demandes de réservation.
             - Visualisation des détails du colis et des photos.
             - Action : Confirmer (Accepter) ou Rejeter.
             - Action post-paiement : Marquer comme Livré.

        3.4.4. Gestion des Réservations (Client)
             - Suivi du statut en temps réel.
             - Action : Payer (une fois confirmée).
             - Action : Annuler (sous conditions).
             - Action : Confirmer la réception (Clôture la transaction).

   3.5. MODULE PAIEMENTS ET TRANSACTIONS (Payments & Payouts)
        Gestion des flux financiers sécurisés.

        3.5.1. Paiement Client (Payment)
             - Paiement sécurisé pour une réservation spécifique.
             - Calcul automatique du montant total (Prix vol + Frais service + Assurance éventuelle).
             - Génération d'un reçu/facture de transaction.
             - Mise à jour immédiate du statut de réservation.

        3.5.2. Reversement Voyageur (Payout)
             - Calcul des gains du voyageur (Montant total - Commission plateforme).
             - Système de "Cagnotte" ou solde virtuel.
             - Demande de virement (Payout Request) vers le compte bancaire enregistré.
             - Validation et exécution des virements par l'administrateur.
             - Historique des transactions et reversements.

        3.5.3. Remboursements (Refunds)
             - Gestion des cas d'annulation après paiement.
             - Calcul automatique du montant à rembourser selon les règles d'annulation (remboursement total, partiel, ou nul selon le délai).
             - Traitement des remboursements vers le moyen de paiement original.

   3.6. MODULE NOTIFICATIONS ET COMMUNICATION
        Tenir les utilisateurs informés à chaque étape.

        3.6.1. Emails Transactionnels (Mailgun/SMTP)
             - Bienvenue / Validation compte.
             - Nouvelle demande de réservation (pour le voyageur).
             - Réservation acceptée/refusée (pour le client).
             - Paiement reçu.
             - Colis livré.
             - Réinitialisation mot de passe.

        3.6.2. Notifications SMS (Twilio)
             - Codes de validation (OTP).
             - Alertes urgentes sur le statut des vols ou réservations.

        3.6.3. Newsletter
             - Inscription/Désinscription à la lettre d'information.
             - Envoi de campagnes marketing (Admin).

   3.7. MODULE ADMINISTRATION ET STATISTIQUES (Back-Office)
        Outils de pilotage pour l'opérateur de la plateforme.

        3.7.1. Tableau de Bord (Dashboard)
             - Vue d'ensemble de l'activité.
             - Nombre de vols actifs, réservations en cours.
             - Chiffre d'affaires global, commissions perçues.

        3.7.2. Gestion des Opérations
             - Supervision de toutes les transactions.
             - Intervention manuelle sur les statuts de réservation en cas de litige.
             - Validation des documents d'identité.

        3.7.3. Statistiques
             - Rapports financiers (Gains, Remboursements).
             - Analyse de l'utilisation (Nouveaux inscrits, Top destinations).
             - Taux de conversion et performance des vols.

   3.8. MODULE AVIS ET NOTATIONS (Reviews)
        Système de confiance communautaire.

        3.8.1. Notation Voyageur
             - Le client note le voyageur après la livraison.
             - Critères : Communication, Ponctualité, Soin du colis.
             - Commentaire textuel.

        3.8.2. Calcul de la Réputation
             - Affichage de la note moyenne sur le profil public du voyageur.
             - Impact sur la visibilité des vols.

4. RÈGLES DE GESTION ET CONTRAINTES MÉTIER

   4.1. Règles de Vol
        - Un vol ne peut être modifié s'il a des réservations actives.
        - La capacité (kilos) disponible diminue automatiquement à chaque réservation confirmée.
        - Un vol passé ne peut plus recevoir de réservations.

   4.2. Règles de Réservation
        - Poids maximum par colis : 100 kg (configurable).
        - Photos obligatoires : Minimum 1, Maximum 5. Format image strict.
        - Délai de paiement : Une réservation confirmée doit être payée sous X heures (configurable, ex: 24h), sinon elle est annulée automatiquement (Job planifié).

   4.3. Règles Financières
        - Commission plateforme : Pourcentage prélevé sur chaque transaction.
        - Séquestre : L'argent est conservé par la plateforme jusqu'à la confirmation de la livraison (Protection acheteur).
        - Seuil de virement : Montant minimum pour demander un reversement.

5. EXIGENCES NON FONCTIONNELLES ET TECHNIQUES

   5.1. Sécurité
        - Chiffrement : Mots de passe hachés (BCrypt). Données bancaires chiffrées en base (AES-256).
        - API : Protection REST, HTTPS obligatoire.
        - Accès : RBAC (Role-Based Access Control) strict sur tous les endpoints.
        - Uploads : Validation type MIME et analyse anti-malware (recommandée).

   5.2. Performance et Disponibilité
        - Caching : Utilisation de Redis pour mettre en cache les données fréquentes (vols, configurations) afin de réduire la charge BDD.
        - Pagination : Toutes les listes (vols, historique) sont paginées pour optimiser les temps de réponse.
        - Asynchronisme : Envoi d'emails et traitements lourds exécutés en tâche de fond (@Async).

   5.3. Internationalisation
        - Support multi-devises (Base : EUR).
        - Gestion des fuseaux horaires pour les vols (Dates stockées en UTC ou avec Timezone).
        - Support des données géographiques (Pays, Villes, Aéroports internationaux).

   5.4. Stack Technique (Déduite du code)
        - Backend : Java 16+, Spring Boot 3.x.
        - Base de données : MySQL.
        - ORM : Hibernate / JPA.
        - Outils : Lombok, MapStruct, Maven.
        - Services Tiers : Twilio (SMS), Mailgun/SMTP (Email), Redis (Cache).
        - Documentation API : OpenAPI / Swagger UI.

6. INTERFACES (API REST)
   L'application expose une API RESTful complète.
   - /auth/** : Authentification.
   - /trips/** : Gestion des vols (Public & Privé).
   - /api/bookings/** : Gestion des réservations.
   - /customer/** : Espace client.
   - /payment/** : Transactions.
   - /admin/** : Espace administration.
   - /stats/** : Données statistiques.
   - /api/profile/** : Gestion profil et photos.

7. EVOLUTIONS POSSIBLES (Futures)
   - Intégration d'une messagerie instantanée (Chat) entre Client et Voyageur.
   - Application mobile native.
   - Système de tracking GPS temps réel du colis lors du voyage.
   - Assurance transport intégrée via partenaire tiers.
